<!DOCTYPE html>
<!--
 * WebAudio based ASAP
 *
 * Copyright (C) 2015 Juergen Wothke
 *
 * This file is based on ASAP (Another Slight Atari Player),
 * see http://asap.sourceforge.net
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published
 * by the Free Software Foundation; either version 2 of the License,
 * or (at your option) any later version.
 *
 * ASAP is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ASAP; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *-->
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<title>WebAsap - HTML5/JavaScript based ASAP music player</title>
<!-- emulate arrows of "HTML5 <details>" in Firefox-->
<style>			
	.no-details details > summary:before { float: left; width: 15px; content: '\25B6'; }
	.no-details details.open > summary:before { content: '\25BC'; }
</style>

<meta name="description" content="Experimental WebAudio version of ASAP">
<meta name="author" content="Juergen Wothke">
<meta name="keywords" content="Web Audio API, HTML5, JavaScript, Atari 8-bit, music, ASAP">

<!--link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css"-->
<link href="font.css" rel="stylesheet" type="text/css">
<link href="common.css" rel="stylesheet" type="text/css">
<link rel="image_src" href="screenshot.gif" />
<meta property="og:image" content="http://www.wothke.ch/webasap/screenshot.gif" />



<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link type="image/x-icon" href="favicon.ico" />


<script type="text/javascript" src="asap.js"></script>
<script type="text/javascript" src="asap_player.js"></script>

<script src="stdlib/jquery1.11.min.js"></script>
<script src="stdlib/jquery.details.min.js"></script-->
<script>
	window.console || (window.console = { 'log': alert });
	$(function() {
		$('html').addClass($.fn.details.support ? 'details' : 'no-details');
		$('details').details();

		if (!window.webkitAudioContext) {
			// hack to get rid of Firefox specific pseudo elements used to sim webkit-box-reflect
			var e = document.getElementById("moz-reflect-logo");		
			e.className += " enableMozReflection";
			var e2 = document.getElementById("moz-reflect-spectrum");		
			e2.className += " enableMozReflection";
		}
	});	
</script>


<script>
var someSongs = [	'music/Tempest_Xtreem_Song_One.sap;0;60',
					'music/Archon.sap;0;45',
					'music/Ballblazer.sap;0;45',
					'music/Blade_Runner_Stereo.sap;0;60',
					'music/Boulder_Dash.sap;0;45',
					'music/Enola_Gay.sap;0;60',
					'music/Extirpator.sap;0;60',
					'music/Fairlight.sap;0;60',
					'music/Ghosts_n_Goblins.sap;0;60',
					'music/Ghouls_n_Ghosts.sap;0;60',
					'music/Lemmings_Intro_2.sap;0;60',
					'music/Lemmings_Prevision.sap;0;60',
					'music/Megablast.sap;0;60',
					'music/Monty_on_the_Run_Game_Over.sap;0;240',
					'music/Ode_to_Prosonix.sap;0;60',
					'music/Pentagram_4_Axel_F.sap;0;60',
					'music/Warhawk.sap;0;45',
					'music/Xevious.sap;0;30',
					'music/Yie_Ar_Kung_Fu_Title.sap;0;120',
					'music/Tempest_2000_Blue_Level.sap;0;45'
				];

// ---------------------    setup player -----------------------------------
var player= new SamplePlayer(onEnd);

function onEnd() {
	audio.playNextSong();

}

// ---------------------    drag&drop feature -----------------------------------
function allowDrop(ev) {
    ev.preventDefault();
}
function drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("Text");
	var file = ev.dataTransfer.files[0];
	if (file instanceof File) {
		var f= window.audio['playSongFile'].bind(window.audio);
		f(file, 0, -1);
	}
}

// ---------------------    WebAudio setup -----------------------------------
Audio = function(songs, onUpdate) {
	this.audioCtx;
	this.bufferSource;
	this.gainNode;
	this.analyzerNode;
	
	this.current=-1;
	this.someSongs= songs;
	this.onUpdate= onUpdate;
};

Audio.prototype = {
	initialAudioSetup: function() {
		if (typeof this.bufferSource != 'undefined') { 
			this.bufferSource.stop(0);
		} else {
			this.setupAudioNodes();
		}
	},
	setupAudioNodes: function() {
		if (typeof this.audioCtx == 'undefined') {
			try {
				window.AudioContext = window.AudioContext||window.webkitAudioContext;
				this.audioCtx = new AudioContext();
			} catch(e) {
				alert('Web Audio API is not supported in this browser (get Chrome 18 or Firefox 26)');
			}
			this.analyzerNode = this.audioCtx.createAnalyser();
			var scriptNode = player.createScriptProcessor(this.audioCtx);
			this.gainNode = this.audioCtx.createGain();
						
			scriptNode.connect(this.gainNode);
			this.gainNode.connect(this.analyzerNode);
			this.analyzerNode.connect(this.audioCtx.destination);
		}
	},
	playNextSong: function() {
		this.current= (++this.current >=this.someSongs.length) ? 0 : this.current;
		var someSong= this.someSongs[this.current];
		this.playSong(someSong);
	},
	playPreviousSong: function() {
		this.current= (--this.current<0) ? this.current+this.someSongs.length : this.current;
		var someSong= this.someSongs[this.current];
		this.playSong(someSong);
	},
	playSongFile: function(file, track, timeout) {
		var reader = new FileReader();
		reader.onload = function() {		
			this.playSongBinary(file.name, new Uint8Array(reader.result), track, timeout);
		}.bind(this);
		reader.readAsArrayBuffer(file);		
	},
	playSongBinary: function(name, data, track, timeout) {
		player.playSong(name, data, track, timeout);

		this.initialAudioSetup();			
		this.onUpdate();
		this.startMusicPlayback();	
	},
	playSong: function(someSong) {
		var arr= someSong.split(";");	
		var track= arr.length>1?parseInt(arr[1]):-1;
		var timeout= arr.length>2?parseInt(arr[2]):-1;
		var name= arr[0]; 
		
		var xhr = new XMLHttpRequest();
		xhr.open("GET", name, true);
		xhr.responseType = "arraybuffer";

		xhr.onload = function (oEvent) {
			this.playSongBinary(name, xhr.response, track, timeout);
		}.bind(this);
		xhr.send(null);
	},
	startMusicPlayback: function() {
		player.setPauseMode(false);

		if (typeof this.bufferSource === 'undefined') {
			this.bufferSource = this.audioCtx.createBufferSource();
			if (!this.bufferSource.start) {
			  this.bufferSource.start = this.bufferSource.noteOn;
			  this.bufferSource.stop = this.bufferSource.noteOff;
			}
			this.bufferSource.start(0);		
		}
	},
};

// ----------------------- setup some visuals ----------------------------
Graphix = function(audio) {
	this.audio= audio;
	this.backgroundImg= 0;
	
	this.WIDTH= 800;
	this.HEIGHT= 200;

	this.canvasSpectrum = document.getElementById('spectrumCanvas');
	this.ctxSpectrum = this.canvasSpectrum.getContext('2d');
	this.canvasSpectrum.width = this.WIDTH;

	
  this.mozReflectSpectrum = document.getElementById('moz-reflect-spectrum');
  this.mozReflectLogo = document.getElementById('moz-reflect-logo');
	
	var canvas2 = document.getElementById('logoCanvas');
	this.ctxLegend = canvas2.getContext('2d');
	
};

Graphix.prototype = {
	updateImage: function(src) {
		this.backgroundImg= 0;
		var imgObj = new Image();

		imgObj.onload = function () { 
			this.backgroundImg= imgObj;
		}.bind(this);
		imgObj.src=src;
	},

	reqAnimationFrame: function() {
		window.requestAnimationFrame(this.redrawSpectrum.bind(this));
	},
	redrawSpectrum: function() {
		this.reqAnimationFrame();
		
		var freqByteData = new Uint8Array(this.audio.analyzerNode.frequencyBinCount);
		this.audio.analyzerNode.getByteFrequencyData(freqByteData);

		var SPACER_WIDTH = 10;
		var BAR_WIDTH = 5;
		var OFFSET = 100;
		var patternHeight= 9;	
		var patternWidth= 295;	
		
		var numBars = Math.round(this.WIDTH / SPACER_WIDTH);

		this.ctxSpectrum.clearRect(0, 0, this.WIDTH, this.HEIGHT);

		this.ctxSpectrum.fillStyle = '#fe5139';
		this.ctxSpectrum.lineCap = 'round';

		
		if (this.backgroundImg) {
			for (var i = 0; i < numBars; ++i) {
			var scale= freqByteData[i + OFFSET]/0xff;
			var magnitude = scale*this.HEIGHT;				
				
				x=i/numBars*patternWidth;
				this.ctxSpectrum.drawImage(this.backgroundImg, 
										// clip image
										x,0, 								// sx, sy
										BAR_WIDTH, patternHeight, 					// swidth, sheight
										// position clipped image
										i * SPACER_WIDTH, this.HEIGHT - magnitude,	// x, y
										BAR_WIDTH, 30);	// width, height
					
				// hack: make sure dumb Firefox knows that redraw is needed..
				this.mozReflectSpectrum.style.visibility = "hidden";
				this.mozReflectSpectrum.style.visibility = "visible";
			}
		}
	},
	text: function(ctx, text, x, y) {
		ctx.strokeText(text, x, y);
		ctx.fillText(text, x, y);
	},
	redrawSongInfo: function() {
		this.reqAnimationFrame();
		
		this.ctxLegend.clearRect(0, 0, 800, 300);
		
		this.ctxLegend.textBaseline = "middle";
		this.ctxLegend.fillStyle = '#000';
		this.ctxLegend.strokeStyle = "#FFFFFF";
		
		this.ctxLegend.font = '90px serif bold';
		
		this.text(this.ctxLegend, "Atari 8-bit", 20, 70);
		this.ctxLegend.font = '25px sans-serif';
		this.text(this.ctxLegend, "music nostalgia", 20, 125);

		this.ctxLegend.fillStyle = '#888';
		this.ctxLegend.font = '25px sans-serif';

		this.ctxLegend.textBaseline = 'bottom';
		this.text(this.ctxLegend, player.songName, 20, 190);
		this.text(this.ctxLegend, player.songAuthor, 20, 230);
		this.text(this.ctxLegend, player.songReleased, 20, 270);
		// hack: make sure dumb Firefox knows that redraw is needed..
		this.mozReflectLogo.style.visibility = "hidden";
		this.mozReflectLogo.style.visibility = "visible";
	},
};

function updateGUI() {
	gfx.reqAnimationFrame();
	if (!gfx.backgroundImg) gfx.updateImage("colbar.jpg");		

	gfx.redrawSongInfo();
}


// ----------------------- get the party going  --------------------------
function init() {
	audio= new Audio(someSongs, updateGUI);
	gfx= new Graphix(audio);

	document.getElementById("previous").onclick = audio.playPreviousSong.bind(audio);
	document.getElementById("next").onclick = audio.playNextSong.bind(audio);
			
	document.getElementById("play").onclick = function(e){
		player.setPauseMode(false);
	};
	document.getElementById("pause").onclick = function(e){
		player.setPauseMode(true);
	};
	document.getElementById("gain").onchange = function(e){
		audio.gainNode.gain.value= this.value/255;
	};
	document.getElementById("speed").onchange = function(e){
		var tweak= 0.2; 			// allow 20% speed correction
		var f= (this.value/50)-1;	// -1..1
		
		var s= player.getDefaultSampleRate();		
		s= Math.round(s*(1+(tweak*f)));
		
		player.setSampleRate(s);
	};

	audio.playNextSong();
}

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60370798-1', 'auto');
  ga('send', 'pageview');

</script>

</head>

<body onload="init();">
<div class="tooltip" alt="This is a hobby project, but it costs not only time to regularily maintain this site but also money to pay for the internet service provider (etc). If you want to keep this site up and running.. or if you just like my work (see https://jwothke.wordpress.com/) and you'd like to see more of it in the future, please make a contribution. Thank you!">
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="E7ACAHA7W5FYC">
<input type="image" src="btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="pixel.gif" width="1" height="1">
</form>
</div>

<details>
  <summary>What's this?</summary>
  <div>
 <p>
    Experimental HTML5/WebAudio integration of <a href="http://asap.sourceforge.net/" target="_blank">Another Slight Atari Player</a>. ASAP is a player of Atari 8-bit music for modern computers and mobile devices. It emulates the POKEY sound chip and the 6502 processor.</p>
  
  <p>The asap.js emulator code used on this page was translated from the original C code using Emscripten. (The resulting code seems to be somewhat more performant than the <a href="http://cito.sourceforge.net/" target="blank">cito</a> generated JavaScript version already available in the ASAP project's "Desktop player in JavaScript" folder. I took care to preserve the API of the 'cito' version so the two versions can be used interchangeably here.)</p>

  <p>2015 by Juergen Wothke </p>
  
  <p>Use your own music files by dropping them on the Atari 800. The source code of this page can be found <a href="https://github.com/wothke" target="_blank">here</a>. You can find my other WebAudio players in action <a href="http://www.wothke.ch/tinyrsid/index.php/webaudio-players" target="_blank">here</a>.</p>
  
 <p>Please use controls on the right (e.g. to play another song): 
<button id="play"> &gt;</button>
<button id="pause"> ||</button>
<button id="previous"> |&lt;&lt;</button>
<button id="next"> &gt;&gt;|</button>
<input type="range" id="gain" name="gain" min="1" max="255" value="255">
<input type="range" id="speed" name="speed" min="0" max="100" value="50">

 </div>
</details>
<aside>
  
</aside>

<section>
   <div id="logo" class="logo">
	<div id="moz-reflect-logo"><canvas  id="logoCanvas"  width="600" height="270"></canvas></div>
  </div>
  <div id="spectrum" class="spectrum">
  	<div id="moz-reflect-spectrum"><canvas id="spectrumCanvas" width="512" height="200"></canvas></div>
  </div>
  <div id="drop" class="drop" ondrop="drop(event)" ondragover="allowDrop(event)">
 <img src="Atari_800.gif" width=300 height=300/>
  </div>
  
</section>
</body>
</html>
